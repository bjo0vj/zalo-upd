HƯỚNG DẪN DEPLOY ZEID BOT LÊN RAILWAY VỚI POSTGRESQL
=====================================================

Tài liệu này hướng dẫn chi tiết cách deploy bot lên Railway và kết nối với cơ sở dữ liệu PostgreSQL để lưu trữ dữ liệu bền vững (Persistent Storage).

PHẦN 1: CHUẨN BỊ CODE (Đã thực hiện)
------------------------------------
Tôi đã thêm các file cần thiết vào source code của bạn:
1. `utils/database.js`: Module kết nối Database và các hàm hỗ trợ (lưu cache, lưu tin nhắn).
2. `database/init.sql`: File chứa cấu trúc bảng (Schema) cho Database.
3. `scripts/migrate.js`: Script để khởi tạo bảng trong Database.

⚠️ QUAN TRỌNG: CÀI ĐẶT THƯ VIỆN
Bạn cần thêm thư viện `pg` (PostgreSQL client) vào `package.json`.
Mở file `package.json`, tìm phần `"dependencies"` và thêm dòng sau (hoặc chạy lệnh npm install nếu ở local):
    "pg": "^8.11.3"

PHẦN 2: TẠO PROJECT TRÊN RAILWAY
--------------------------------
1. Đăng nhập vào [Railway Dashboard](https://railway.app/).
2. Nhấn **"New Project"** -> **"Deploy from GitHub repo"**.
3. Chọn repository chứa code bot của bạn.
4. Nhấn **"Add a Variable"** (nếu cần) hoặc cứ để nó deploy lần đầu (có thể lỗi do chưa config, không sao).

PHẦN 3: THÊM DATABASE (POSTGRESQL)
----------------------------------
1. Trong giao diện project trên Railway, nhấn chuột phải vào khoảng trống hoặc nút **"New"**.
2. Chọn **"Database"** -> **"PostgreSQL"**.
3. Đợi một chút để Railway khởi tạo Database.

PHẦN 4: KẾT NỐI BOT VỚI DATABASE
--------------------------------
1. Nhấn vào thẻ **PostgreSQL** vừa tạo -> chọn tab **"Connect"**.
2. Copy giá trị của **DATABASE_URL** (nó trông như `postgresql://postgres:password@...`).
3. Quay lại thẻ **Service** (cái chứa code bot của bạn) -> chọn tab **"Variables"**.
4. Thêm biến môi trường mới:
   - Tên (Name): `DATABASE_URL`
   - Giá trị (Value): [Dán link bạn vừa copy ở bước 2]
5. Thêm các biến môi trường khác nếu chưa có (ví dụ `ZALO_TOKEN` nếu bạn dùng env var thay vì config file).

PHẦN 5: KHỞI TẠO DATABASE (MIGRATION)
-------------------------------------
Để tạo các bảng `cache` và `messages`, bạn cần chạy script migration.

Cách 1: Chạy tự động khi Deploy (Khuyên dùng)
1. Trong thẻ **Service** của bot -> tab **"Settings"**.
2. Tìm phần **"Deploy"** -> **"Start Command"**.
3. Sửa lệnh Start Command thành:
   `node scripts/migrate.js && node index.js`
   (Lệnh này sẽ chạy migration trước, nếu thành công mới chạy bot).

Cách 2: Chạy thủ công trên máy tính (Local)
1. Cài đặt dependencies: `npm install`
2. Tạo file `.env` ở thư mục gốc, thêm dòng: `DATABASE_URL=...` (lấy từ Railway).
3. Chạy lệnh: `node scripts/migrate.js`

PHẦN 6: SỬ DỤNG TRONG CODE (DÀNH CHO DEV)
-----------------------------------------
Bây giờ bạn có thể sử dụng module `database` để lưu dữ liệu thay vì lưu file JSON/TXT.

Ví dụ sử dụng trong plugin:

```javascript
const db = require('../../utils/database');

module.exports.run = async function({ api, event }) {
    // 1. Lưu cache (ví dụ lưu trạng thái user)
    await db.saveCache('user_123_status', { step: 1, mode: 'vip' });

    // 2. Đọc cache
    const status = await db.loadCache('user_123_status');
    
    // 3. Lưu tin nhắn vào lịch sử
    await db.appendMessage(
        event.senderID, 
        event.body, 
        { threadId: event.threadId, timestamp: Date.now() } // Metadata (JSON)
    );
};
```

LƯU Ý QUAN TRỌNG
----------------
1. **Quota Free:** Railway có giới hạn giờ chạy hoặc credit ($5) cho tài khoản Trial. Hãy kiểm tra thường xuyên.
2. **Dữ liệu file:** Các file bạn lưu bằng `fs.writeFileSync` (như `history_data` cũ) sẽ **MẤT** mỗi khi bạn deploy lại hoặc Railway restart bot. Chỉ có dữ liệu trong PostgreSQL là được giữ lại.
3. **Chuyển đổi:** Để bot hoạt động hoàn toàn trên Railway, bạn nên dần dần chuyển các tính năng đang dùng file (như `tracking.js`, `imageHistoryTracker.js`) sang dùng `utils/database.js`.

CHÚC BẠN THÀNH CÔNG!
